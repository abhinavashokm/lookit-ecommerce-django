{% extends 'admin_base/base.html' %}
{% load static %}
{% block styles %}
<link rel="stylesheet" href="{% static 'order/css/admin/order_details.css' %}">
<link rel="stylesheet" href="{% static 'admin/css/components/pagination.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}


{% block content %}
<!-- Main Content -->
<main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
        <div class="breadcrumbs">
            <a href="{% url 'admin-list-orders' %}">Orders</a>
            <span>/</span>
            <span>View Order</span>
        </div>
        <h1 class="page-title">Order Details</h1>
    </div>

    <div class="order-details-container">
        <!-- Order Summary Card -->
        <div class="order-card">
            <div class="card-header">
                <h2>Order Summary</h2>
                <button class="btn btn-outline">
                    <i class="fas fa-download"></i> Export as CSV
                </button>
            </div>
            <div class="card-body">
                <div class="order-info-grid">
                    <div class="info-group">
                        <div class="info-group-header">
                            <i class="fas fa-truck"></i>
                            <span>Order Status</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Order ID</span>
                            <span class="info-value">#ORD-{{ order.id|stringformat:'04d'  }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date</span>
                            <span class="info-value">{{ order.created_at.date }}</span>
                        </div>
                        <div class="info-item status-row">
                            <span class="info-label">Status</span>
                            <span class="status-badge status-shipped">{{ order.order_status }}</span>
                        </div>
                    </div>

                    <div class="info-group">
                        <div class="info-group-header">
                            <i class="fas fa-credit-card"></i>
                            <span>Payment Details</span>
                        </div>
                        <div class="info-item status-row">
                            <span class="info-label">Status</span>
                            <span class="status-badge status-delivered">{{ order.payment_status }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Method</span>
                            <span class="info-value">{{ order.order.payment_method }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Amount</span>
                            <span class="info-value total-amount">₹{{ order.total }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Information -->
        <div class="info-cards-container">
             <div class="info-card">
            <div class="card-header">
                 <h2><i class="fas fa-user"></i> Customer Information</h2>
            </div>
            <div class="card-body">
                <div class="customer-info">
                    <div class="customer-avatar">
                        <img src="{% if customer.profile_img_url %}{{ customer.profile_img_url }}{% else %}https://ui-avatars.com/api/?name=Amelia+Bennett&background=6366f1&color=fff&size=160{% endif %}"
                            alt="{{ cusomer.full_name }}">
                    </div>
                    <div class="customer-details">
                        <div>
                        <div class="info-item">
                            <span class="info-label">Name</span>
                            <span class="info-value">{{ customer.full_name }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">{{ customer.email }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone</span>
                            <span class="info-value">{{ customer.phone }}</span>
                        </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Delivery Address -->
        <div class="info-card">
            <div class="card-header">
                <h2><i class="fas fa-truck"></i> Delivery Address</h2>
            </div>
            <div class="card-body">
                <div class="delivery-address">
                    <div class="address-line">
                        <i class="fas fa-user"></i>
                        <span>{{ address.full_name }}</span>
                    </div>
                    <div class="address-line">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>{{ address.address_line }}</span>
                    </div>
                    <div class="address-line">
                        <i class="fas fa-city"></i>
                        <span>{{ address.city }}, {{ address.state }}, Pin: {{ address.pincode }}</span>
                    </div>
                    <div class="address-line">
                        <i class="fas fa-phone"></i>
                        <span>{{ address.phone }}{% if address.second_phone %}, {{ address.second_phone }}{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Product Details -->
        <div class="order-card">
            <div class="card-header">
                <h2>Product Details</h2>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="product-table">
                        <thead>
                            <tr>
                                <th>Image</th>
                                <th>Product Details</th>
                                <th>Size</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div class="product-image">
                                        <img src="{{ order.product.image_url }}" alt="{{ order.product.name }}">
                                    </div>
                                </td>
                                <td>
                                    <div class="product-details">
                                        <div class="product-name">{{ order.product.name }}</div>
                                        <div class="product-id">ID: PRD-{{ order.id|stringformat:'04d' }}</div>
                                    </div>
                                </td>
                                <td>
                                    <div class="variant-details">
                                        <span>{{ order.variant.size }}</span>
                                    </div>
                                </td>
                                <td class="text-center">{{ order.quantity }}</td>
                                <td class="text-right">₹{{ order.unit_price }}</td>
                                <td class="text-right">₹{{ order.sub_total }}</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="5" class="text-right">Subtotal</td>
                                <td>₹{{ order.sub_total }}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right">Shipping</td>
                                <td>₹{{ order.delivery_fee }}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right">Tax Amount</td>
                                <td>₹{{ order.tax_amount }}</td>
                            </tr>
                            <tr class="total-row">
                                <td colspan="5" class="text-right"><strong>Total</strong></td>
                                <td><strong>₹{{ order.total }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Order Status and Payment Details Row -->
        <div class="order-cards-row">

            {% if order.order_status != 'CANCELLED' %}
            <!-- Order Status timeline -->
            <div class="order-card">
                <div class="card-header">
                    <h2>Order Status</h2>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h4>Order Initiated</h4>
                                <p>{{ order.created_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        <div class="timeline-item {% if  order.order_status == 'SHIPPED' or order.order_status == 'DELIVERED' or order.order_status == 'OUT_FOR_DELIVERY' %}completed{% elif order.order_status == 'PLACED' %}active{% endif %}">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Order Placed</h4>
                                <p>{{ order.placed_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.order_status == 'DELIVERED' or order.order_status == 'OUT_FOR_DELIVERY' %}completed{% elif order.order_status == 'SHIPPED' %}active{% endif %}">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Shipped</h4>
                                <p>{{ order.shipped_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.order_status == 'DELIVERED' %}completed{% elif order.order_status == 'OUT_FOR_DELIVERY' %}active{% endif %}">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Out For Delivery</h4>
                                <p>{{ order.out_for_delivery_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        <div class="timeline-item {% if order.order_status == 'DELIVERED' %}active{% endif %}">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h4>Delivered</h4>
                                <p>{{ order.delivered_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!--For cancelled orders-->
            <div class="order-card">
                <div class="card-header">
                    <h2>Order Status</h2>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h4>Order Initiated</h4>
                                <p>{{ order.created_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        <div class="timeline-item completed">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Order Placed</h4>
                                <p>{{ order.placed_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        {% if order.shipped_at %}
                        <div class="timeline-item completed">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Shipped</h4>
                                <p>{{ order.shipped_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if order.out_for_delivery_at %}
                        <div class="timeline-item completed">
                            <div class="timeline-dot active"></div>
                            <div class="timeline-content">
                                <h4>Out For Delivery</h4>
                                <p>{{ order.out_for_delivery_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="timeline-item cancel-active">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h4 class="timeline-title">Cancelled</h4>
                                <p class="timeline-date">{{ order.cancelled_at|date:"d M Y, h:i A" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Payment Details -->
            <div class="order-card">
                <div class="card-header">
                    <h2>Payment Details</h2>
                </div>
                <div class="card-body">
                    <div class="payment-details">
                        <div class="info-item">
                            <span class="info-label">Method</span>
                            <span class="info-value">{{ order.order.payment_method }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Transaction ID</span>
                            <span class="info-value">TXN123456789</span>
                        </div>
                        <div class="info-item status-row">
                            <span class="info-label">Status</span>
                            <span class="status-badge status-delivered">{{ order.payment_status }}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Paid Date</span>
                            <span class="info-value">July 15, 2024</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Mode</span>
                            <span class="info-value">Online</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="openStatusModal()">
                <i class="fas fa-edit"></i> Change Order Status
            </button>
            <button class="btn btn-danger" onclick="openDeleteModal()">
                <i class="fas fa-times"></i> Cancel Order
            </button>
        </div>

    </div>
</main>

<!--Change order status model-->
<div id="statusModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Change Order Status</h3>
            <button class="close-btn" onclick="closeStatusModal()">&times;</button>
        </div>
        <form action="{% url 'update-delivery-status' order.uuid %}" method="post">
            {% csrf_token %}
            <div class="modal-body">
                <div class="order-info">
                    <p><strong>Order ID:</strong> #ORD-{{ order.id|stringformat:'04d' }}</p>
                    <p><strong>Product:</strong> {{ order.product.name }}</p>
                </div>
            
                <div class="form-group">
                    <label for="statusSelect">New Status</label>
                    <select name="order_status" id="statusSelect" class="form-control">
                        <option value="" disabled selected>select status</option>
                        <option value="placed" >Placed</option>
                        <option value="shipped">Shipped</option>
                        <option value="out_for_delivery">Out For Delivery</option>
                        <option value="delivered">Delivered</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="returned">Returned</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Status</button>
            </div>
        </form>
    </div>
</div>

<!-- Cancel Confirmation Modal -->
<div class="modal-overlay" id="deleteModal{{style.id}}">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">Cancel Order</h2>
        </div>
        <div class="modal-body">
            <p class="modal-message">Are you sure you want to Cancel this Order?<strong id="deleteStyleId"></strong></p>
        </div>
        <div class="modal-actions">
            <button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal('{{style.id}}')">Close</button>
            <a href="#">
                <button class="modal-btn modal-btn-confirm" onclick="confirmDelete('{{style.id}}')">Confirm</button>
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{% static 'order/js/admin/order_details.js' %}"></script>
{% endblock %}