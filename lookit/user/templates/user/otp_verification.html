<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verify OTP - LookIt</title>
  <link rel="stylesheet" href="{% static 'user/css/otp_verification.css' %}">
</head>

<body>

  <div class="otp-card" role="region" aria-labelledby="otp-title">
    <h2 id="otp-title" class="title">Verify Your Email</h2>

    <p class="subtitle">Enter the 6-digit OTP sent to your email address.</p>

    {% if messages %}
    {% for message in messages %}
    <div class="error-box">
      {{message}}
    </div>
    {% endfor %}
    {% endif %}

    <form method="post" id="otp_form">
      {% csrf_token %}
      <div class="form-group">
        <input type="tel" name="otp" id="otp-input" placeholder="Enter OTP" pattern="[0-9]{6}" inputmode="numeric"
          maxlength="6" required>
      </div>

      <button type="submit" class="verify-btn">Verify OTP</button>
    </form>

    <div class="resend-section">
      Didn't receive the code? <span id="resend-timer">Resend OTP in <span id="timer-display"></span></span>
      <a href="{% url 'signup-send-otp' %}" id="resend-link" style="display: none;">Resend OTP</a>
    </div>

    <div class="back-link">
      <a class="back-link" href="{% url 'user-signup' %}">Back to sign in</a>

    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>


  <script>
    $(document).ready(function () {
      // Restrict OTP input to numbers only
      $('#otp-input').on('input', function () {
        this.value = this.value.replace(/[^0-9]/g, '');
      });

      // Prevent non-numeric characters on keypress
      $('#otp-input').on('keypress', function (e) {
        const char = String.fromCharCode(e.which);
        if (!/[0-9]/.test(char)) {
          e.preventDefault();
        }
      });

      // Prevent paste of non-numeric characters
      $('#otp-input').on('paste', function (e) {
        const paste = (e.originalEvent || e).clipboardData.getData('text');
        if (!/^[0-9]+$/.test(paste)) {
          e.preventDefault();
        }
      });

      $("#otp_form").validate({
        rules: {
          otp: {
            required: true,
            digits: true,
            minlength: 6,
            maxlength: 6
          }
        },
        messages: {
          otp: {
            required: "Please enter the OTP",
            digits: "OTP can contain only numbers",
            minlength: "OTP must be 6 digits",
            maxlength: "OTP must be 6 digits"
          }
        },
        onkeyup: true,
        errorClass: "error",
        errorElement: "label",
        errorPlacement: function (error, element) {
          error.insertAfter(element);
        }
      });
    });
  </script>


  <!--autohide error messages after 3 seconds-->
  <script>
    setTimeout(function () {
      const alerts = document.querySelectorAll('.error-box');
      alerts.forEach(alert => {
        alert.style.transition = "opacity 0.8s";
        alert.style.opacity = "0";
        setTimeout(() => alert.remove(), 800);
      });
    }, 3000);
  </script>


  <script>
    //for otp timer to persist page reload
    const expires_at = parseFloat("{{ otp_expires_at|floatformat:0 }}"); //server timestamp

    // Save expiry locally so it persists across reloads
    localStorage.setItem("otp_expires_at", expires_at)
  </script>

  <!-- Resend OTP Timer -->
  <script>
      (function () {
         const expiry_time = parseFloat(localStorage.getItem("otp_expires_at"));
        const current_time = Date.now() / 1000; // convert ms â†’ seconds

        let timeLeft = Math.floor(expiry_time - current_time); //remaining seconds
        const timerDisplay = document.getElementById('timer-display');
        const resendTimer = document.getElementById('resend-timer');
        const resendLink = document.getElementById('resend-link');

        function formatTime(seconds) {
          const minutes = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimer() {
          timerDisplay.textContent = formatTime(timeLeft);

          if (timeLeft > 0) {
            timeLeft--;
            setTimeout(updateTimer, 1000);
          } else {
            resendTimer.style.display = 'none';
            resendLink.style.display = 'inline';
          }
        }

        // Start the timer when page loads
        updateTimer();
      })();
  </script>

</body>

</html>